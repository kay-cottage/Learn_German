<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ–‡æœ¬é«˜äº®å·¥å…·</title>
<style>
/* ==================== å…¨å±€ ==================== */
*{margin:0;padding:0;box-sizing:border-box;}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#f5f5f5;
  height:100vh;
  display:flex;
  flex-direction:column;
}

/* ==================== é¡¶éƒ¨å·¥å…·æ  ==================== */
.toolbar{
  background:#fff;
  border-bottom:1px solid #e0e0e0;
  padding:12px 20px;
  display:flex;
  align-items:center;
  gap:12px;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}
.toolbar button{
  padding:8px 16px;
  border:1px solid #ddd;
  background:#fff;
  border-radius:6px;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}
.toolbar button:hover{background:#f0f0f0;}
.toolbar button.active{
  background:#007bff;
  color:#fff;
  border-color:#007bff;
}

/* é¢œè‰²æŒ‰é’® */
.color-selector{display:flex;gap:8px;}
.color-btn{
  width:32px;height:32px;
  border:2px solid #ddd;
  border-radius:4px;
  cursor:pointer;
  transition:.2s;
}
.color-btn:hover{transform:scale(1.1);}
.color-btn.active{
  border-color:#333;
  transform:scale(1.1);
}

/* ==================== ä¸»å¸ƒå±€ ==================== */
.main-container{
  flex:1;
  display:flex;
  height:calc(100vh - 70px);
}

/* å·¦ä¾§è¾“å…¥åŒº */
.input-section{
  width:50%;
  background:#fff;
  border-right:1px solid #e0e0e0;
  display:flex;
  flex-direction:column;
  transition:.3s;
}
.input-section.collapsed{
  width:0;
  overflow:hidden;
}
.input-header{
  padding:16px;
  background:#f8f9fa;
  border-bottom:1px solid #e0e0e0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.input-header>div{display:flex;align-items:center;gap:12px;}
.input-area{flex:1;padding:16px;}
#textInput{
  width:100%;height:100%;
  border:1px solid #ddd;
  border-radius:6px;
  padding:12px;
  font-size:14px;
  resize:none;
  font-family:inherit;
}

/* å³ä¾§æ˜¾ç¤ºåŒº */
.display-section{
  flex:1;
  background:#fff;
  display:flex;
  flex-direction:column;
}
.display-header{
  padding:16px;
  background:#f8f9fa;
  border-bottom:1px solid #e0e0e0;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.display-content{
  flex:1;
  padding:20px;
  overflow-y:auto;
  line-height:1.6;
  font-size:14px;
  user-select:text;
}

/* ==================== é«˜äº®æ ·å¼ ==================== */
.highlight{
  padding:2px 4px;
  border-radius:3px;
  margin:0 1px;
  cursor:pointer;
  transition:.2s;
}
.highlight:hover{box-shadow:0 0 0 2px rgba(0,123,255,.3);}
.highlight.selected{box-shadow:0 0 0 2px #007bff;}

.highlight-yellow {background:#fff3cd;}
.highlight-green  {background:#d4edda;}
.highlight-blue   {background:#cce5ff;}
.highlight-pink   {background:#f8d7da;}
.highlight-purple {background:#e2e3ff;}

/* ==================== å·²ä¿å­˜å†…å®¹é¢æ¿ ==================== */
.saved-content{
  margin-top:20px;
  padding:16px;
  background:#f8f9fa;
  border-radius:6px;
  border:1px solid #e0e0e0;
  transition:.3s;
}
.saved-content.collapsed{
  height:50px;
  overflow:hidden;
}
.saved-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.saved-item{
  margin-bottom:8px;
  padding:8px;
  background:#fff;
  border-radius:4px;
  border-left:4px solid #007bff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.saved-item-actions{margin-left:12px;}
.delete-btn{
  background:#dc3545;
  color:#fff;
  border:none;
  padding:4px 8px;
  border-radius:4px;
  cursor:pointer;
  font-size:12px;
}
.delete-btn:hover{background:#c82333;}

/* ==================== å¸¸ç”¨æŒ‰é’®/é€‰æ‹©å™¨ ==================== */
.format-select{
  padding:6px 10px;
  border:1px solid #ddd;
  border-radius:4px;
  background:#fff;
  font-size:12px;
}
.toggle-btn{
  background:#007bff;
  color:#fff;
  border:none;
  padding:6px 12px;
  border-radius:4px;
  cursor:pointer;
  font-size:12px;
}
.toggle-btn:hover{background:#0056b3;}

/* ==================== å³é”®èœå• ==================== */
.context-menu{
  position:fixed;
  background:#fff;
  border:1px solid #ddd;
  border-radius:6px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
  z-index:1000;
  min-width:120px;
  display:none;
}
.context-menu-item{
  padding:8px 12px;
  cursor:pointer;
  font-size:14px;
  color:#333;
  border-bottom:1px solid #f0f0f0;
}
.context-menu-item:last-child{border-bottom:none;}
.context-menu-item:hover{background:#f8f9fa;}
.context-menu-item.danger{color:#dc3545;}
.context-menu-item.danger:hover{background:#f8d7da;}
</style>
</head>
<body>
<!-- =============== å·¥å…·æ  =============== -->
<div class="toolbar">
  <button id="highlightBtn">ğŸ–ï¸ é«˜äº®å·¥å…·</button>
  <div class="color-selector">
    <div class="color-btn highlight-yellow" data-color="yellow"></div>
    <div class="color-btn highlight-green"  data-color="green"></div>
    <div class="color-btn highlight-blue"   data-color="blue"></div>
    <div class="color-btn highlight-pink"   data-color="pink"></div>
    <div class="color-btn highlight-purple" data-color="purple"></div>
  </div>
  <button id="deleteSelectedBtn">ğŸ—‘ åˆ é™¤é€‰ä¸­</button>
  <button id="saveBtn">ğŸ’¾ ä¿å­˜é«˜äº®</button>
  <button id="exportTxtBtn">ğŸ“„ å¯¼å‡ºTXT</button>
  <button id="exportJsonBtn">ğŸ“‹ å¯¼å‡ºJSON</button>
  <button id="exportMdBtn">ğŸ“ å¯¼å‡ºMarkdown</button>
  <button id="clearBtn">ğŸ—‘ æ¸…é™¤é«˜äº®</button>
</div>

<!-- =============== ä¸»ä½“ =============== -->
<div class="main-container">
  <!-- å·¦ï¼šè¾“å…¥ -->
  <div class="input-section" id="inputSection">
    <div class="input-header">
      <h3>æ–‡æœ¬è¾“å…¥</h3>
      <div>
        <select id="formatSelect" class="format-select">
          <option value="text">çº¯æ–‡æœ¬</option>
          <option value="markdown">Markdown</option>
        </select>
        <button class="toggle-btn" id="collapseBtn">æ”¶èµ·</button>
      </div>
    </div>
    <div class="input-area">
      <textarea id="textInput" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
    </div>
  </div>

  <!-- å³ï¼šæ˜¾ç¤º -->
  <div class="display-section">
    <div class="display-header">
      <h3>æ˜¾ç¤ºåŒºåŸŸ</h3>
      <button class="toggle-btn" id="expandBtn" style="display:none;">å±•å¼€è¾“å…¥åŒº</button>
    </div>
    <div class="display-content" id="displayContent">
      <p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>
    </div>

    <!-- ä¿å­˜é¢æ¿ -->
    <div class="saved-content" id="savedContent" style="display:none;">
      <div class="saved-header">
        <h3>å·²ä¿å­˜çš„é«˜äº®å†…å®¹</h3>
        <button class="toggle-btn" id="savedToggleBtn">æ”¶èµ·</button>
      </div>
      <div id="savedList"></div>
    </div>
  </div>
</div>

<!-- å³é”®èœå• -->
<div class="context-menu" id="contextMenu">
  <div class="context-menu-item danger" id="deleteHighlightItem">åˆ é™¤é«˜äº®</div>
</div>

<!-- ==================== è„šæœ¬ ==================== -->
<script>
class TextHighlighter{
  constructor(){
    /* çŠ¶æ€ */
    this.isHighlightMode=false;
    this.currentColor='yellow';
    this.highlightId=0;
    this.selectedHighlight=null;
    this.savedHighlights=[];
    /* è®¾å¤‡åˆ¤å®š */
    this.isIOS=/iP(ad|hone|od)/i.test(navigator.userAgent);

    /* DOM ç¼“å­˜ */
    const $=id=>document.getElementById(id);
    this.highlightBtn=$('highlightBtn');
    this.colorBtns=document.querySelectorAll('.color-btn');
    this.deleteSelectedBtn=$('deleteSelectedBtn');
    this.saveBtn=$('saveBtn');
    this.exportTxtBtn=$('exportTxtBtn');
    this.exportJsonBtn=$('exportJsonBtn');
    this.exportMdBtn=$('exportMdBtn');
    this.clearBtn=$('clearBtn');
    this.formatSelect=$('formatSelect');
    this.textInput=$('textInput');
    this.displayContent=$('displayContent');
    this.collapseBtn=$('collapseBtn');
    this.expandBtn=$('expandBtn');
    this.inputSection=$('inputSection');
    this.savedContent=$('savedContent');
    this.savedList=$('savedList');
    this.savedToggleBtn=$('savedToggleBtn');
    this.contextMenu=$('contextMenu');
    this.deleteHighlightItem=$('deleteHighlightItem');
    this.colorBtns[0].classList.add('active');

    this.bindEvents();
  }

  /* ========== äº‹ä»¶ç»‘å®š ========== */
  bindEvents(){
    /* å·¥å…·æ  */
    this.highlightBtn.addEventListener('click',()=>this.toggleMode());
    this.colorBtns.forEach(btn=>btn.addEventListener('click',e=>this.pickColor(e.target)));
    this.deleteSelectedBtn.addEventListener('click',()=>this.deleteSelected());
    this.saveBtn.addEventListener('click',()=>this.saveHighlights());
    this.exportTxtBtn.addEventListener('click',()=>this.exportTxt());
    this.exportJsonBtn.addEventListener('click',()=>this.exportJson());
    this.exportMdBtn.addEventListener('click',()=>this.exportMd());
    this.clearBtn.addEventListener('click',()=>this.clearAll());

    this.textInput.addEventListener('input',()=>this.renderDisplay());
    this.formatSelect.addEventListener('change',()=>this.renderDisplay());

    this.collapseBtn.addEventListener('click',()=>this.toggleInput());
    this.expandBtn  .addEventListener('click',()=>this.toggleInput());
    this.savedToggleBtn.addEventListener('click',()=>this.toggleSaved());
    this.deleteHighlightItem.addEventListener('click',()=>this.deleteFromMenu());

    /* ç‚¹å‡» & å³é”® */
    document.addEventListener('click',e=>this.handleClick(e));
    document.addEventListener('contextmenu',e=>this.handleCtx(e));

    /* é€‰åŒºç›‘å¬ï¼šiOS ä¸å…¶å®ƒå¹³å°å·®å¼‚åŒ– */
    if(this.isIOS){
      document.addEventListener('selectionchange',()=>this.cacheSelection());
      ['pointerup','touchend'].forEach(evt=>document.addEventListener(evt,()=>this.commitHighlight()));
    }else{
      ['mouseup','pointerup'].forEach(evt=>document.addEventListener(evt,()=>this.commitHighlight()));
    }
  }

  /* ========== æ¨¡å¼ / é¢œè‰² ========== */
  toggleMode(){
    this.isHighlightMode=!this.isHighlightMode;
    this.highlightBtn.classList.toggle('active',this.isHighlightMode);
    this.highlightBtn.innerText=this.isHighlightMode?'ğŸ–ï¸ å…³é—­é«˜äº®':'ğŸ–ï¸ é«˜äº®å·¥å…·';
  }
  pickColor(btn){
    this.colorBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    this.currentColor=btn.dataset.color;
  }

  /* ========== é€‰åŒºå¤„ç† ========== */
  cacheSelection(){
    if(!this.isHighlightMode) return;
    const sel=window.getSelection();
    if(sel.rangeCount) this.cachedRange=sel.getRangeAt(0).cloneRange();
  }
  commitHighlight(){
    if(!this.isHighlightMode) return;

    const sel=window.getSelection();
    const range=this.isIOS?this.cachedRange:(sel.rangeCount?sel.getRangeAt(0):null);
    if(!range||range.collapsed||range.toString().trim()==='') return;
    /* å¿…é¡»åœ¨æ˜¾ç¤ºåŒºå†… */
    if(!this.displayContent.contains(range.commonAncestorContainer)) return;

    /* â€”â€” å…ˆæ‹†äº¤å æ—§é«˜äº®ï¼Œå†åŒ…æ–°é«˜äº® â€”â€” */
    this.removeHighlightsInRange(range);
    this.wrapRange(range);

    sel.removeAllRanges();
    this.cachedRange=null;
  }

  /* æ‹†è§£ä¸ range ç›¸äº¤çš„æ—§é«˜äº® */
  removeHighlightsInRange(range){
    const hs=[...this.displayContent.querySelectorAll('.highlight')];
    hs.forEach(h=>{
      if(!range.intersectsNode(h)) return;
      this.unwrap(h);
    });
  }
  /* unwrap é«˜äº®èŠ‚ç‚¹ */
  unwrap(span){
    const parent=span.parentNode;
    while(span.firstChild) parent.insertBefore(span.firstChild,span);
    parent.removeChild(span);
    parent.normalize();
  }

  /* åŒ…è£¹æ–°é«˜äº® */
  wrapRange(range){
    const span=document.createElement('span');
    span.className=`highlight highlight-${this.currentColor}`;
    span.dataset.highlightId=this.highlightId++;
    try{range.surroundContents(span);}
    catch{
      const frag=range.extractContents();
      span.appendChild(frag);
      range.insertNode(span);
    }
  }

  /* ========== ç‚¹å‡» / å³é”® ========== */
  handleClick(e){
    this.contextMenu.style.display='none';
    if(e.target.classList.contains('highlight')){
      this.displayContent.querySelectorAll('.highlight.selected').forEach(h=>h.classList.remove('selected'));
      e.target.classList.add('selected');this.selectedHighlight=e.target;
    }else{
      this.displayContent.querySelectorAll('.highlight.selected').forEach(h=>h.classList.remove('selected'));
      this.selectedHighlight=null;
    }
  }
  handleCtx(e){
    if(e.target.classList.contains('highlight')){
      e.preventDefault();
      this.handleClick(e);
      this.contextMenu.style.display='block';
      this.contextMenu.style.left=e.pageX+'px';
      this.contextMenu.style.top=e.pageY+'px';
    }else this.contextMenu.style.display='none';
  }
  deleteFromMenu(){
    if(this.selectedHighlight) this.deleteNode(this.selectedHighlight);
    this.contextMenu.style.display='none';
  }
  deleteSelected(){
    if(this.selectedHighlight) this.deleteNode(this.selectedHighlight);
    else alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé«˜äº®å†…å®¹');
  }
  deleteNode(node){
    /* è¿™é‡Œæ”¹æˆ unwrapï¼Œä¿ç•™å†…éƒ¨æ¢è¡Œ/æ ‡ç­¾ */
    this.unwrap(node);
    this.selectedHighlight=null;
  }

  /* ========== ä¿å­˜ / å¯¼å‡º / æ¸…ç©º ========== */
  saveHighlights(){
    const hs=this.displayContent.querySelectorAll('.highlight');
    if(!hs.length){alert('æ²¡æœ‰æ‰¾åˆ°é«˜äº®å†…å®¹');return;}

    const arr=[];
    hs.forEach(h=>{
      const txt=h.textContent.trim();
      if(!txt) return;
      const info=this.getLineInfo(h);
      arr.push({
        text:txt,
        color:this.getColor(h),
        line:info.line,
        position:info.position
      });
    });

    /* æŒ‰è¡Œåˆå¹¶ */
    const byLine={};
    arr.forEach(i=>{(byLine[i.line]=byLine[i.line]||[]).push(i);});
    this.savedHighlights=[];
    Object.keys(byLine).sort((a,b)=>a-b).forEach(line=>{
      const items=byLine[line].sort((a,b)=>a.position-b.position);
      this.savedHighlights.push({
        line:+line,
        text:items.map(i=>i.text).join(' '),
        items
      });
    });
    this.displaySaved();
  }
  exportTxt(){
    if(!this.savedHighlights.length){alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');return;}
    const content=this.savedHighlights.map(i=>i.text).join('\n');
    this.download(content,'highlights.txt','text/plain');
  }
  exportJson(){
    if(!this.savedHighlights.length){alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');return;}
    const content=JSON.stringify(this.savedHighlights,null,2);
    this.download(content,'highlights.json','application/json');
  }
  exportMd(){
    const body=this.displayContent.textContent||this.displayContent.innerText;
    const md=`# æ–‡æ¡£å†…å®¹\n\n${body}\n\n## é«˜äº®å†…å®¹\n\n${this.savedHighlights.map(i=>`- ${i.text}`).join('\n')}`;
    this.download(md,'document.md','text/markdown');
  }
  clearAll(){
    this.displayContent.querySelectorAll('.highlight').forEach(h=>this.unwrap(h));
    this.savedHighlights=[];
    this.displaySaved();
    this.selectedHighlight=null;
  }

  /* å·¥å…·å‡½æ•° */
  download(content,name,type){
    const blob=new Blob([content],{type});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=name;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  getLineInfo(el){
    const dr=this.displayContent.getBoundingClientRect();
    const er=el.getBoundingClientRect();
    const lh=parseInt(getComputedStyle(this.displayContent).lineHeight);
    return{
      line:Math.floor((er.top-dr.top)/lh),
      position:er.left-dr.left
    };
  }
  getColor(el){
    for(const c of el.classList) if(c.startsWith('highlight-')) return c.replace('highlight-','');
    return'yellow';
  }

  /* ========== ä¿å­˜é¢æ¿æ¸²æŸ“ ========== */
  displaySaved(){
    if(!this.savedHighlights.length){
      this.savedContent.style.display='none';
      return;
    }
    this.savedContent.style.display='block';
    this.savedList.innerHTML='';
    this.savedHighlights.forEach((item,i)=>{
      const div=document.createElement('div');
      div.className='saved-item';
      div.innerHTML=`
        <div class="saved-item-content"><strong>ç¬¬${item.line+1}è¡Œ:</strong> ${item.text}</div>
        <div class="saved-item-actions">
          <button class="delete-btn" onclick="highlighter.deleteSavedItem(${i})">åˆ é™¤</button>
        </div>`;
      this.savedList.appendChild(div);
    });
  }
  deleteSavedItem(i){
    this.savedHighlights.splice(i,1);
    this.displaySaved();
  }

  /* ========== è¾“å…¥åŒºæ¸²æŸ“ ========== */
  renderDisplay(){
    const txt=this.textInput.value;
    const fmt=this.formatSelect.value;

    if(!txt.trim()){
      this.displayContent.innerHTML='<p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>';
      return;
    }

    if(fmt==='markdown'){
      let html=txt
        .replace(/^### (.*$)/gim,'<h3>$1</h3>')
        .replace(/^## (.*$)/gim,'<h2>$1</h2>')
        .replace(/^# (.*$)/gim,'<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
        .replace(/\*(.*?)\*/g,'<em>$1</em>')
        .replace(/`(.*?)`/g,'<code style="background:#f4f4f4;padding:2px 4px;border-radius:3px;">$1</code>')
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:#007bff;">$1</a>')
        .replace(/\n/g,'<br>');
      this.displayContent.innerHTML=`<div>${html}</div>`;
    }else{
      this.displayContent.innerHTML=`<div>${txt.replace(/\n/g,'<br>')}</div>`;
    }
  }

  /* ========== æŠ˜å /å±•å¼€ ========== */
  toggleSaved(){
    const c=this.savedContent.classList.toggle('collapsed');
    this.savedToggleBtn.innerText=c?'å±•å¼€':'æ”¶èµ·';
  }
  toggleInput(){
    const c=this.inputSection.classList.toggle('collapsed');
    this.collapseBtn.style.display=c?'none':'block';
    this.expandBtn.style.display=c?'block':'none';
  }
}

/* åˆå§‹åŒ– */
let highlighter;
document.addEventListener('DOMContentLoaded',()=>{highlighter=new TextHighlighter();});
</script>
</body>
</html>
