<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ–‡æœ¬é«˜äº®å·¥å…·</title>
<style>
  /* â€”â€” æ ·å¼ä¿æŒä¸ä½ åŸæ–‡ä»¶ 100% ä¸€è‡´ â€”â€” */
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;height:100vh;display:flex;flex-direction:column;}
  .toolbar{background:#fff;border-bottom:1px solid #e0e0e0;padding:12px 20px;display:flex;align-items:center;gap:12px;box-shadow:0 2px 4px rgba(0,0,0,.1);}
  .toolbar button{padding:8px 16px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:14px;transition:.2s;}
  .toolbar button:hover{background:#f0f0f0;}
  .toolbar button.active{background:#007bff;color:#fff;border-color:#007bff;}
  .color-selector{display:flex;gap:8px;}
  .color-btn{width:32px;height:32px;border:2px solid #ddd;border-radius:4px;cursor:pointer;transition:.2s;}
  .color-btn:hover{transform:scale(1.1);}
  .color-btn.active{border-color:#333;transform:scale(1.1);}
  .main-container{flex:1;display:flex;height:calc(100vh - 70px);}
  .input-section{width:50%;background:#fff;border-right:1px solid #e0e0e0;display:flex;flex-direction:column;transition:.3s;}
  .input-section.collapsed{width:0;overflow:hidden;}
  .input-header{padding:16px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;}
  .input-header>div{display:flex;align-items:center;gap:12px;}
  .input-area{flex:1;padding:16px;}
  #textInput{width:100%;height:100%;border:1px solid #ddd;border-radius:6px;padding:12px;font-size:14px;resize:none;font-family:inherit;}
  .display-section{flex:1;background:#fff;display:flex;flex-direction:column;}
  .display-header{padding:16px;background:#f8f9fa;border-bottom:1px solid #e0e0e0;display:flex;justify-content:space-between;align-items:center;}
  .display-content{flex:1;padding:20px;overflow-y:auto;line-height:1.6;font-size:14px;user-select:text;}
  .highlight{padding:2px 4px;border-radius:3px;margin:0 1px;cursor:pointer;transition:.2s;}
  .highlight:hover{box-shadow:0 0 0 2px rgba(0,123,255,.3);}
  .highlight.selected{box-shadow:0 0 0 2px #007bff;}
  .highlight-yellow{background:#fff3cd;}
  .highlight-green{background:#d4edda;}
  .highlight-blue{background:#cce5ff;}
  .highlight-pink{background:#f8d7da;}
  .highlight-purple{background:#e2e3ff;}
  .saved-content{margin-top:20px;padding:16px;background:#f8f9fa;border-radius:6px;border:1px solid #e0e0e0;transition:.3s;}
  .saved-content.collapsed{height:50px;overflow:hidden;}
  .saved-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
  .saved-content h3{color:#333;margin:0;}
  .saved-item{margin-bottom:8px;padding:8px;background:#fff;border-radius:4px;border-left:4px solid #007bff;display:flex;justify-content:space-between;align-items:center;}
  .saved-item-actions{margin-left:12px;}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px;}
  .delete-btn:hover{background:#c82333;}
  .format-select{padding:6px 10px;border:1px solid #ddd;border-radius:4px;background:#fff;font-size:12px;}
  .toggle-btn{background:#007bff;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;}
  .toggle-btn:hover{background:#0056b3;}
  .context-menu{position:fixed;background:#fff;border:1px solid #ddd;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;min-width:120px;display:none;}
  .context-menu-item{padding:8px 12px;cursor:pointer;font-size:14px;color:#333;border-bottom:1px solid #f0f0f0;}
  .context-menu-item:last-child{border-bottom:none;}
  .context-menu-item:hover{background:#f8f9fa;}
  .context-menu-item.danger{color:#dc3545;}
  .context-menu-item.danger:hover{background:#f8d7da;}
</style>
</head>
<body>
  <!-- â€”â€”â€” å·¥å…·æ  â€”â€”â€” -->
  <div class="toolbar">
    <button id="highlightBtn">ğŸ–ï¸ é«˜äº®å·¥å…·</button>
    <div class="color-selector">
      <div class="color-btn highlight-yellow" data-color="yellow"></div>
      <div class="color-btn highlight-green"  data-color="green"></div>
      <div class="color-btn highlight-blue"   data-color="blue"></div>
      <div class="color-btn highlight-pink"   data-color="pink"></div>
      <div class="color-btn highlight-purple" data-color="purple"></div>
    </div>
    <button id="deleteSelectedBtn">ğŸ—‘ åˆ é™¤é€‰ä¸­</button>
    <button id="saveBtn">ğŸ’¾ ä¿å­˜é«˜äº®</button>
    <button id="exportTxtBtn">ğŸ“„ å¯¼å‡ºTXT</button>
    <button id="exportJsonBtn">ğŸ“‹ å¯¼å‡ºJSON</button>
    <button id="exportMdBtn">ğŸ“ å¯¼å‡ºMarkdown</button>
    <button id="clearBtn">ğŸ—‘ æ¸…é™¤é«˜äº®</button>
  </div>

  <!-- â€”â€”â€” ä¸»ä½“ â€”â€”â€” -->
  <div class="main-container">
    <div class="input-section" id="inputSection">
      <div class="input-header">
        <h3>æ–‡æœ¬è¾“å…¥</h3>
        <div>
          <select id="formatSelect" class="format-select">
            <option value="text">çº¯æ–‡æœ¬</option>
            <option value="markdown">Markdown</option>
          </select>
          <button class="toggle-btn" id="collapseBtn">æ”¶èµ·</button>
        </div>
      </div>
      <div class="input-area">
        <textarea id="textInput" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
      </div>
    </div>

    <div class="display-section">
      <div class="display-header">
        <h3>æ˜¾ç¤ºåŒºåŸŸ</h3>
        <button class="toggle-btn" id="expandBtn" style="display:none;">å±•å¼€è¾“å…¥åŒº</button>
      </div>
      <div class="display-content" id="displayContent">
        <p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>
      </div>

      <div class="saved-content" id="savedContent" style="display:none;">
        <div class="saved-header">
          <h3>å·²ä¿å­˜çš„é«˜äº®å†…å®¹</h3>
          <button class="toggle-btn" id="savedToggleBtn">æ”¶èµ·</button>
        </div>
        <div id="savedList"></div>
      </div>
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div class="context-menu" id="contextMenu">
    <div class="context-menu-item danger" id="deleteHighlightItem">åˆ é™¤é«˜äº®</div>
  </div>

<script>
class TextHighlighter{
  constructor(){
    /* ====== åŸºç¡€å±æ€§ ====== */
    this.isHighlightMode=false;
    this.currentColor='yellow';
    this.savedHighlights=[];
    this.highlightId=0;
    this.selectedHighlight=null;
    /* ====== è®¾å¤‡æ£€æµ‹ ====== */
    this.isIOS=/iP(ad|hone|od)/i.test(navigator.userAgent);
    this.supportsPointer=!!window.PointerEvent;

    this.initElements();
    this.bindEvents();
  }

  /* === DOM ç¼“å­˜ === */
  initElements(){
    const g=id=>document.getElementById(id);
    this.highlightBtn       =g('highlightBtn');
    this.colorBtns          =document.querySelectorAll('.color-btn');
    this.deleteSelectedBtn  =g('deleteSelectedBtn');
    this.saveBtn            =g('saveBtn');
    this.exportTxtBtn       =g('exportTxtBtn');
    this.exportJsonBtn      =g('exportJsonBtn');
    this.exportMdBtn        =g('exportMdBtn');
    this.clearBtn           =g('clearBtn');
    this.formatSelect       =g('formatSelect');
    this.textInput          =g('textInput');
    this.displayContent     =g('displayContent');
    this.collapseBtn        =g('collapseBtn');
    this.expandBtn          =g('expandBtn');
    this.inputSection       =g('inputSection');
    this.savedContent       =g('savedContent');
    this.savedList          =g('savedList');
    this.savedToggleBtn     =g('savedToggleBtn');
    this.contextMenu        =g('contextMenu');
    this.deleteHighlightItem=g('deleteHighlightItem');
    this.colorBtns[0].classList.add('active');
  }

  /* === äº‹ä»¶ç»‘å®š === */
  bindEvents(){
    /* å·¥å…·æ æŒ‰é’® */
    this.highlightBtn.addEventListener('click',()=>this.toggleHighlightMode());
    this.colorBtns.forEach(btn=>btn.addEventListener('click',e=>this.selectColor(e.target)));
    this.deleteSelectedBtn.addEventListener('click',()=>this.deleteSelectedHighlight());
    this.saveBtn.addEventListener('click', ()=>this.saveHighlights());
    this.exportTxtBtn.addEventListener('click',()=>this.exportTxt());
    this.exportJsonBtn.addEventListener('click',()=>this.exportJson());
    this.exportMdBtn.addEventListener('click',()=>this.exportMarkdown());
    this.clearBtn.addEventListener('click',   ()=>this.clearHighlights());
    this.textInput.addEventListener('input',  ()=>this.updateDisplay());
    this.formatSelect.addEventListener('change',()=>this.updateDisplay());
    this.collapseBtn.addEventListener('click',()=>this.toggleInputSection());
    this.expandBtn.addEventListener('click',  ()=>this.toggleInputSection());
    this.savedToggleBtn.addEventListener('click',()=>this.toggleSavedSection());
    this.deleteHighlightItem.addEventListener('click',()=>this.deleteHighlightFromMenu());

    /* ç‚¹å‡» / å³é”® */
    document.addEventListener('click',     e=>this.handleClick(e));
    document.addEventListener('contextmenu',e=>this.handleContextMenu(e));

    /* â€”â€”â€” é€‰åŒºç›‘å¬ï¼šæŒ‰è®¾å¤‡å·®å¼‚åŒ– â€”â€”â€” */
    if(this.isIOS){
      /* iOS ä¸Š selectionchange é¢‘ç‡æé«˜ã€ä½† PointerEvent å¯é 
         æ‰€ä»¥ï¼šselectionchange â†’ åªè®°å½• rangeï¼Œä¸è¿›è¡Œé«˜äº®
              pointerup/touchend â†’ çœŸæ­£æ‰§è¡Œé«˜äº® */
      document.addEventListener('selectionchange',()=>this.storeCurrentSelection());
      ['pointerup','touchend'].forEach(evt=>{
        document.addEventListener(evt,()=>this.commitHighlight());
      });
    }else{
      /* æ¡Œé¢ / Androidï¼šmouseup & pointerup ä¸€æ¬¡æ€§å®Œæˆ */
      ['pointerup','mouseup'].forEach(evt=>{
        document.addEventListener(evt,()=>this.commitHighlight());
      });
    }
  }

  /* ========== é«˜äº®æ¨¡å¼ / é¢œè‰² ========== */
  toggleHighlightMode(){
    this.isHighlightMode=!this.isHighlightMode;
    this.highlightBtn.classList.toggle('active',this.isHighlightMode);
    this.highlightBtn.innerText=this.isHighlightMode?'ğŸ–ï¸ å…³é—­é«˜äº®':'ğŸ–ï¸ é«˜äº®å·¥å…·';
  }
  selectColor(btn){
    this.colorBtns.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    this.currentColor=btn.dataset.color;
  }

  /* ========== é€‰åŒºå¤„ç† ========== */
  storeCurrentSelection(){
    /* åªåœ¨ iOS ä¸‹ä½¿ç”¨ï¼šè®°å½•å½“å‰ Rangeï¼Œé¿å…é¢‘ç¹ DOM æ“ä½œ */
    if(!this.isHighlightMode) return;
    const sel=window.getSelection();
    if(!sel.rangeCount) return;
    this.cachedRange=sel.getRangeAt(0).cloneRange();
  }

  commitHighlight(){
    if(!this.isHighlightMode) return;
    const sel=window.getSelection();
    let range=null;

    /* iOSï¼šä¼˜å…ˆç”¨ cachedRangeï¼›å…¶å®ƒç›´æ¥æ‹¿å½“å‰ selection */
    if(this.isIOS){
      if(!this.cachedRange || this.cachedRange.collapsed) return;
      range=this.cachedRange;
    }else{
      if(!sel.rangeCount||sel.toString().trim()==='') return;
      range=sel.getRangeAt(0);
    }

    /* ä»…åœ¨æ˜¾ç¤ºåŒºåŸŸå†…æ‰é«˜äº® */
    const node=range.commonAncestorContainer;
    if(!this.displayContent.contains(node)&&node!==this.displayContent) return;

    this.highlightRange(range);

    /* æ¸…æ‰é€‰åŒºã€ç¼“å­˜ */
    sel.removeAllRanges();
    this.cachedRange=null;
  }

  highlightRange(range){
    if(range.toString().trim()==='') return;
    const span=document.createElement('span');
    span.className=`highlight highlight-${this.currentColor}`;
    span.dataset.highlightId=this.highlightId++;
    try{
      range.surroundContents(span);
    }catch{
      const frag=range.extractContents();
      span.appendChild(frag);
      range.insertNode(span);
    }
  }

  /* ========== ç‚¹å‡» / å³é”®é€‰ä¸­æŸä¸ªé«˜äº® ========== */
  handleClick(e){
    this.contextMenu.style.display='none';
    if(e.target.classList.contains('highlight')){
      this.displayContent.querySelectorAll('.highlight.selected').forEach(h=>h.classList.remove('selected'));
      e.target.classList.add('selected');
      this.selectedHighlight=e.target;
    }else{
      this.displayContent.querySelectorAll('.highlight.selected').forEach(h=>h.classList.remove('selected'));
      this.selectedHighlight=null;
    }
  }
  handleContextMenu(e){
    if(e.target.classList.contains('highlight')){
      e.preventDefault();
      this.displayContent.querySelectorAll('.highlight.selected').forEach(h=>h.classList.remove('selected'));
      e.target.classList.add('selected');
      this.selectedHighlight=e.target;
      this.contextMenu.style.display='block';
      this.contextMenu.style.left=e.pageX+'px';
      this.contextMenu.style.top =e.pageY+'px';
    }else{
      this.contextMenu.style.display='none';
    }
  }
  deleteHighlightFromMenu(){
    if(this.selectedHighlight) this.deleteHighlight(this.selectedHighlight);
    this.contextMenu.style.display='none';
  }
  deleteSelectedHighlight(){
    if(this.selectedHighlight) this.deleteHighlight(this.selectedHighlight);
    else alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé«˜äº®å†…å®¹');
  }
  deleteHighlight(el){
    const p=el.parentNode;
    p.replaceChild(document.createTextNode(el.textContent),el);
    p.normalize();
    this.selectedHighlight=null;
  }

  /* ========== ä¿å­˜ / å¯¼å‡º / æ¸…é™¤ ========== */
  saveHighlights(){
    const hs=this.displayContent.querySelectorAll('.highlight');
    if(!hs.length){alert('æ²¡æœ‰æ‰¾åˆ°é«˜äº®å†…å®¹');return;}
    const arr=[];
    hs.forEach(h=>{
      const txt=h.textContent.trim();
      if(!txt) return;
      const info=this.getLineInfo(h);
      arr.push({text:txt,color:this.getHighlightColor(h),line:info.line,position:info.position});
    });
    /* æŒ‰è¡Œåˆå¹¶ */
    const byLine={};
    arr.forEach(i=>(byLine[i.line]=byLine[i.line]||[]).push(i));
    this.savedHighlights=[];
    Object.keys(byLine).sort((a,b)=>a-b).forEach(line=>{
      const items=byLine[line].sort((a,b)=>a.position-b.position);
      this.savedHighlights.push({line:+line,text:items.map(i=>i.text).join(' '),items});
    });
    this.displaySavedHighlights();
  }
  getLineInfo(el){
    const dr=this.displayContent.getBoundingClientRect();
    const er=el.getBoundingClientRect();
    const lh=parseInt(getComputedStyle(this.displayContent).lineHeight);
    return{line:Math.floor((er.top-dr.top)/lh),position:er.left-dr.left};
  }
  getHighlightColor(el){
    for(const c of el.classList) if(c.startsWith('highlight-')) return c.replace('highlight-','');
    return'yellow';
  }
  displaySavedHighlights(){
    if(!this.savedHighlights.length){this.savedContent.style.display='none';return;}
    this.savedContent.style.display='block';
    this.savedList.innerHTML='';
    this.savedHighlights.forEach((item,idx)=>{
      const div=document.createElement('div');
      div.className='saved-item';
      div.innerHTML=`<div class="saved-item-content"><strong>ç¬¬${item.line+1}è¡Œ:</strong> ${item.text}</div>
      <div class="saved-item-actions"><button class="delete-btn" onclick="highlighter.deleteSavedItem(${idx})">åˆ é™¤</button></div>`;
      this.savedList.appendChild(div);
    });
  }
  deleteSavedItem(i){this.savedHighlights.splice(i,1);this.displaySavedHighlights();}
  exportTxt(){if(!this.savedHighlights.length){alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');return;}
    this.downloadFile(this.savedHighlights.map(i=>i.text).join('\n'),'highlights.txt','text/plain');}
  exportJson(){if(!this.savedHighlights.length){alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');return;}
    this.downloadFile(JSON.stringify(this.savedHighlights,null,2),'highlights.json','application/json');}
  exportMarkdown(){
    const disp=this.displayContent.textContent||this.displayContent.innerText;
    const md=`# æ–‡æ¡£å†…å®¹\n\n${disp}\n\n## é«˜äº®å†…å®¹\n\n${this.savedHighlights.map(i=>`- ${i.text}`).join('\n')}`;
    this.downloadFile(md,'document.md','text/markdown');
  }
  downloadFile(content,name,type){
    const blob=new Blob([content],{type});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download=name;
    document.body.appendChild(a);a.click();document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
  clearHighlights(){
    this.displayContent.querySelectorAll('.highlight').forEach(h=>{
      const p=h.parentNode;
      p.replaceChild(document.createTextNode(h.textContent),h);
      p.normalize();
    });
    this.savedHighlights=[];
    this.savedContent.style.display='none';
    this.selectedHighlight=null;
  }

  /* ========== ç¼–è¾‘åŒºæ¸²æŸ“ ========== */
  updateDisplay(){
    const txt=this.textInput.value;
    const fmt=this.formatSelect.value;
    if(!txt.trim()){this.displayContent.innerHTML='<p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>';return;}
    if(fmt==='markdown'){
      let t=txt.replace(/^### (.*$)/gim,'<h3>$1</h3>')
               .replace(/^## (.*$)/gim,'<h2>$1</h2>')
               .replace(/^# (.*$)/gim,'<h1>$1</h1>')
               .replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>')
               .replace(/\*(.*?)\*/g,'<em>$1</em>')
               .replace(/`(.*?)`/g,'<code style="background:#f4f4f4;padding:2px 4px;border-radius:3px;">$1</code>')
               .replace(/\[([^\]]+)\]\(([^)]+)\)/g,'<a href="$2" target="_blank" style="color:#007bff;">$1</a>')
               .replace(/\n/g,'<br>');
      this.displayContent.innerHTML=`<div>${t}</div>`;
    }else{
      this.displayContent.innerHTML=`<div>${txt.replace(/\n/g,'<br>')}</div>`;
    }
  }

  /* ========== æŠ˜å é¢æ¿ ========== */
  toggleSavedSection(){
    const col=this.savedContent.classList.toggle('collapsed');
    this.savedToggleBtn.innerText=col?'å±•å¼€':'æ”¶èµ·';
  }
  toggleInputSection(){
    const col=this.inputSection.classList.toggle('collapsed');
    this.collapseBtn.style.display=col?'none':'block';
    this.expandBtn .style.display=col?'block':'none';
  }
}

/* â€”â€”â€” å¯åŠ¨ â€”â€”â€” */
let highlighter;
document.addEventListener('DOMContentLoaded',()=>{highlighter=new TextHighlighter();});
</script>
</body>
</html>
