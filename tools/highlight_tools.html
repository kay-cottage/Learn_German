<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æœ¬é«˜äº®å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: white;
            border-bottom: 1px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .toolbar button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .toolbar button:hover {
            background: #f0f0f0;
        }

        .toolbar button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .color-selector {
            display: flex;
            gap: 8px;
        }

        .color-btn {
            width: 32px;
            height: 32px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.1);
        }

        .main-container {
            flex: 1;
            display: flex;
            height: calc(100vh - 70px);
        }

        .input-section {
            width: 50%;
            background: white;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            transition: all 0.3s;
        }

        .input-section.collapsed {
            width: 0;
            overflow: hidden;
        }

        .input-header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .input-header > div {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .input-area {
            flex: 1;
            padding: 16px;
        }

        #textInput {
            width: 100%;
            height: 100%;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .display-section {
            flex: 1;
            background: white;
            display: flex;
            flex-direction: column;
        }

        .display-header {
            padding: 16px;
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .display-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            line-height: 1.6;
            font-size: 14px;
            user-select: text;
        }

        .highlight {
            padding: 2px 4px;
            border-radius: 3px;
            margin: 0 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .highlight:hover {
            box-shadow: 0 0 0 2px rgba(0,123,255,0.3);
        }

        .highlight.selected {
            box-shadow: 0 0 0 2px #007bff;
        }

        .highlight-yellow { background-color: #fff3cd; }
        .highlight-green { background-color: #d4edda; }
        .highlight-blue { background-color: #cce5ff; }
        .highlight-pink { background-color: #f8d7da; }
        .highlight-purple { background-color: #e2e3ff; }

        .saved-content {
            margin-top: 20px;
            padding: 16px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            transition: all 0.3s;
        }

        .saved-content.collapsed {
            height: 50px;
            overflow: hidden;
        }

        .saved-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .saved-content h3 {
            color: #333;
            margin: 0;
        }

        .saved-item {
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 4px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .saved-item-content {
            flex: 1;
        }

        .saved-item-actions {
            margin-left: 12px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .format-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            font-size: 12px;
        }

        .toggle-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .toggle-btn:hover {
            background: #0056b3;
        }

        /* å³é”®èœå•æ ·å¼ */
        .context-menu {
            position: fixed;
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .context-menu-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: #f8f9fa;
        }

        .context-menu-item.danger {
            color: #dc3545;
        }

        .context-menu-item.danger:hover {
            background: #f8d7da;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <button id="highlightBtn">ğŸ–ï¸ é«˜äº®å·¥å…·</button>
        <div class="color-selector">
            <div class="color-btn highlight-yellow" data-color="yellow" title="é»„è‰²"></div>
            <div class="color-btn highlight-green" data-color="green" title="ç»¿è‰²"></div>
            <div class="color-btn highlight-blue" data-color="blue" title="è“è‰²"></div>
            <div class="color-btn highlight-pink" data-color="pink" title="ç²‰è‰²"></div>
            <div class="color-btn highlight-purple" data-color="purple" title="ç´«è‰²"></div>
        </div>
        <button id="deleteSelectedBtn">ğŸ—‘ï¸ åˆ é™¤é€‰ä¸­</button>
        <button id="saveBtn">ğŸ’¾ ä¿å­˜é«˜äº®</button>
        <button id="exportTxtBtn">ğŸ“„ å¯¼å‡ºTXT</button>
        <button id="exportJsonBtn">ğŸ“‹ å¯¼å‡ºJSON</button>
        <button id="exportMdBtn">ğŸ“ å¯¼å‡ºMarkdown</button>
        <button id="clearBtn">ğŸ—‘ï¸ æ¸…é™¤é«˜äº®</button>
    </div>

    <div class="main-container">
        <div class="input-section" id="inputSection">
            <div class="input-header">
                <h3>æ–‡æœ¬è¾“å…¥</h3>
                <div>
                    <select id="formatSelect" class="format-select">
                        <option value="text">çº¯æ–‡æœ¬</option>
                        <option value="markdown">Markdown</option>
                    </select>
                    <button class="toggle-btn" id="collapseBtn">æ”¶èµ·</button>
                </div>
            </div>
            <div class="input-area">
                <textarea id="textInput" placeholder="åœ¨æ­¤è¾“å…¥æ–‡æœ¬å†…å®¹..."></textarea>
            </div>
        </div>

        <div class="display-section">
            <div class="display-header">
                <h3>æ˜¾ç¤ºåŒºåŸŸ</h3>
                <button class="toggle-btn" id="expandBtn" style="display: none;">å±•å¼€è¾“å…¥åŒº</button>
            </div>
            <div class="display-content" id="displayContent">
                <p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>
            </div>
            <div class="saved-content" id="savedContent" style="display: none;">
                <div class="saved-header">
                    <h3>å·²ä¿å­˜çš„é«˜äº®å†…å®¹</h3>
                    <button class="toggle-btn" id="savedToggleBtn">æ”¶èµ·</button>
                </div>
                <div id="savedList"></div>
            </div>
        </div>
    </div>

    <!-- å³é”®èœå• -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item danger" id="deleteHighlightItem">åˆ é™¤é«˜äº®</div>
    </div>

    <script>
        class TextHighlighter {
            constructor() {
                this.isHighlightMode = false;
                this.currentColor = 'yellow';
                this.savedHighlights = [];
                this.highlightId = 0;
                this.selectedHighlight = null; // å½“å‰é€‰ä¸­çš„é«˜äº®
                
                this.initElements();
                this.bindEvents();
            }

            initElements() {
                this.highlightBtn = document.getElementById('highlightBtn');
                this.colorBtns = document.querySelectorAll('.color-btn');
                this.deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
                this.saveBtn = document.getElementById('saveBtn');
                this.exportTxtBtn = document.getElementById('exportTxtBtn');
                this.exportJsonBtn = document.getElementById('exportJsonBtn');
                this.exportMdBtn = document.getElementById('exportMdBtn');
                this.clearBtn = document.getElementById('clearBtn');
                this.formatSelect = document.getElementById('formatSelect');
                this.textInput = document.getElementById('textInput');
                this.displayContent = document.getElementById('displayContent');
                this.collapseBtn = document.getElementById('collapseBtn');
                this.expandBtn = document.getElementById('expandBtn');
                this.inputSection = document.getElementById('inputSection');
                this.savedContent = document.getElementById('savedContent');
                this.savedList = document.getElementById('savedList');
                this.savedToggleBtn = document.getElementById('savedToggleBtn');
                this.contextMenu = document.getElementById('contextMenu');
                this.deleteHighlightItem = document.getElementById('deleteHighlightItem');

                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªé¢œè‰²
                this.colorBtns[0].classList.add('active');
            }

            bindEvents() {
                this.highlightBtn.addEventListener('click', () => this.toggleHighlightMode());
                
                this.colorBtns.forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectColor(e.target));
                });

                this.deleteSelectedBtn.addEventListener('click', () => this.deleteSelectedHighlight());
                this.saveBtn.addEventListener('click', () => this.saveHighlights());
                this.exportTxtBtn.addEventListener('click', () => this.exportTxt());
                this.exportJsonBtn.addEventListener('click', () => this.exportJson());
                this.exportMdBtn.addEventListener('click', () => this.exportMarkdown());
                this.clearBtn.addEventListener('click', () => this.clearHighlights());

                this.textInput.addEventListener('input', () => this.updateDisplay());
                this.formatSelect.addEventListener('change', () => this.updateDisplay());
                
                this.collapseBtn.addEventListener('click', () => this.toggleInputSection());
                this.expandBtn.addEventListener('click', () => this.toggleInputSection());
                this.savedToggleBtn.addEventListener('click', () => this.toggleSavedSection());

                // å³é”®èœå•äº‹ä»¶
                this.deleteHighlightItem.addEventListener('click', () => this.deleteHighlightFromMenu());

                document.addEventListener('mouseup', (e) => this.handleSelection(e));
                document.addEventListener('click', (e) => this.handleClick(e));
                document.addEventListener('contextmenu', (e) => this.handleContextMenu(e));
            }

            toggleHighlightMode() {
                this.isHighlightMode = !this.isHighlightMode;
                this.highlightBtn.classList.toggle('active', this.isHighlightMode);
                this.highlightBtn.textContent = this.isHighlightMode ? 'ğŸ–ï¸ å…³é—­é«˜äº®' : 'ğŸ–ï¸ é«˜äº®å·¥å…·';
            }

            selectColor(colorBtn) {
                this.colorBtns.forEach(btn => btn.classList.remove('active'));
                colorBtn.classList.add('active');
                this.currentColor = colorBtn.dataset.color;
            }

            handleClick(e) {
                // éšè—å³é”®èœå•
                this.contextMenu.style.display = 'none';
                
                // å¤„ç†é«˜äº®é€‰æ‹©
                if (e.target.classList.contains('highlight')) {
                    // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€
                    this.displayContent.querySelectorAll('.highlight.selected').forEach(h => {
                        h.classList.remove('selected');
                    });
                    
                    // é€‰ä¸­å½“å‰é«˜äº®
                    e.target.classList.add('selected');
                    this.selectedHighlight = e.target;
                } else {
                    // ç‚¹å‡»å…¶ä»–åœ°æ–¹ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
                    this.displayContent.querySelectorAll('.highlight.selected').forEach(h => {
                        h.classList.remove('selected');
                    });
                    this.selectedHighlight = null;
                }
            }

            handleContextMenu(e) {
                // æ£€æŸ¥æ˜¯å¦å³é”®ç‚¹å‡»é«˜äº®
                if (e.target.classList.contains('highlight')) {
                    e.preventDefault();
                    
                    // é€‰ä¸­è¿™ä¸ªé«˜äº®
                    this.displayContent.querySelectorAll('.highlight.selected').forEach(h => {
                        h.classList.remove('selected');
                    });
                    e.target.classList.add('selected');
                    this.selectedHighlight = e.target;
                    
                    // æ˜¾ç¤ºå³é”®èœå•
                    this.contextMenu.style.display = 'block';
                    this.contextMenu.style.left = e.pageX + 'px';
                    this.contextMenu.style.top = e.pageY + 'px';
                } else {
                    // éšè—å³é”®èœå•
                    this.contextMenu.style.display = 'none';
                }
            }

            deleteHighlightFromMenu() {
                if (this.selectedHighlight) {
                    this.deleteHighlight(this.selectedHighlight);
                }
                this.contextMenu.style.display = 'none';
            }

            deleteSelectedHighlight() {
                if (this.selectedHighlight) {
                    this.deleteHighlight(this.selectedHighlight);
                } else {
                    alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªé«˜äº®å†…å®¹');
                }
            }

            deleteHighlight(highlightElement) {
                const parent = highlightElement.parentNode;
                parent.replaceChild(document.createTextNode(highlightElement.textContent), highlightElement);
                parent.normalize();
                this.selectedHighlight = null;
            }

            handleSelection(e) {
                if (!this.isHighlightMode) return;
                
                const selection = window.getSelection();
                if (selection.rangeCount === 0 || selection.toString().trim() === '') return;

                const range = selection.getRangeAt(0);
                const container = range.commonAncestorContainer;
                
                // æ£€æŸ¥é€‰æ‹©æ˜¯å¦åœ¨æ˜¾ç¤ºåŒºåŸŸå†…
                if (!this.displayContent.contains(container) && container !== this.displayContent) return;

                this.highlightSelection(range);
                selection.removeAllRanges();
            }

            highlightSelection(range) {
                const span = document.createElement('span');
                span.className = `highlight highlight-${this.currentColor}`;
                span.dataset.highlightId = this.highlightId++;
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    // å¤„ç†è·¨å…ƒç´ é€‰æ‹©çš„æƒ…å†µ
                    const contents = range.extractContents();
                    span.appendChild(contents);
                    range.insertNode(span);
                }
            }

            saveHighlights() {
                const highlights = this.displayContent.querySelectorAll('.highlight');
                if (highlights.length === 0) {
                    alert('æ²¡æœ‰æ‰¾åˆ°é«˜äº®å†…å®¹');
                    return;
                }

                const saved = [];
                highlights.forEach(highlight => {
                    const text = highlight.textContent.trim();
                    if (text) {
                        const lineInfo = this.getLineInfo(highlight);
                        saved.push({
                            text: text,
                            color: this.getHighlightColor(highlight),
                            line: lineInfo.line,
                            position: lineInfo.position
                        });
                    }
                });

                // æŒ‰è¡Œåˆ†ç»„ä¿å­˜
                const groupedByLine = {};
                saved.forEach(item => {
                    if (!groupedByLine[item.line]) {
                        groupedByLine[item.line] = [];
                    }
                    groupedByLine[item.line].push(item);
                });

                // æŒ‰ä½ç½®æ’åºå¹¶åˆå¹¶åŒè¡Œå†…å®¹
                this.savedHighlights = [];
                Object.keys(groupedByLine).sort((a, b) => parseInt(a) - parseInt(b)).forEach(line => {
                    const lineItems = groupedByLine[line].sort((a, b) => a.position - b.position);
                    const lineText = lineItems.map(item => item.text).join(' ');
                    this.savedHighlights.push({
                        line: parseInt(line),
                        text: lineText,
                        items: lineItems
                    });
                });

                this.displaySavedHighlights();
            }

            getLineInfo(element) {
                const displayRect = this.displayContent.getBoundingClientRect();
                const elementRect = element.getBoundingClientRect();
                const lineHeight = parseInt(window.getComputedStyle(this.displayContent).lineHeight);
                
                const line = Math.floor((elementRect.top - displayRect.top) / lineHeight);
                const position = elementRect.left - displayRect.left;
                
                return { line, position };
            }

            getHighlightColor(element) {
                const classList = element.classList;
                for (let className of classList) {
                    if (className.startsWith('highlight-')) {
                        return className.replace('highlight-', '');
                    }
                }
                return 'yellow';
            }

            displaySavedHighlights() {
                if (this.savedHighlights.length === 0) {
                    this.savedContent.style.display = 'none';
                    return;
                }

                this.savedContent.style.display = 'block';
                this.savedList.innerHTML = '';
                
                this.savedHighlights.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'saved-item';
                    div.innerHTML = `
                        <div class="saved-item-content">
                            <strong>ç¬¬${item.line + 1}è¡Œ:</strong> ${item.text}
                        </div>
                        <div class="saved-item-actions">
                            <button class="delete-btn" onclick="highlighter.deleteSavedItem(${index})">åˆ é™¤</button>
                        </div>
                    `;
                    this.savedList.appendChild(div);
                });
            }

            deleteSavedItem(index) {
                this.savedHighlights.splice(index, 1);
                this.displaySavedHighlights();
            }

            exportTxt() {
                if (this.savedHighlights.length === 0) {
                    alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');
                    return;
                }

                const content = this.savedHighlights.map(item => item.text).join('\n');
                this.downloadFile(content, 'highlights.txt', 'text/plain');
            }

            exportJson() {
                if (this.savedHighlights.length === 0) {
                    alert('æ²¡æœ‰ä¿å­˜çš„é«˜äº®å†…å®¹');
                    return;
                }

                const content = JSON.stringify(this.savedHighlights, null, 2);
                this.downloadFile(content, 'highlights.json', 'application/json');
            }

            exportMarkdown() {
                const displayText = this.displayContent.textContent || this.displayContent.innerText;
                const content = `# æ–‡æ¡£å†…å®¹\n\n${displayText}\n\n## é«˜äº®å†…å®¹\n\n${this.savedHighlights.map(item => `- ${item.text}`).join('\n')}`;
                this.downloadFile(content, 'document.md', 'text/markdown');
            }

            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            clearHighlights() {
                const highlights = this.displayContent.querySelectorAll('.highlight');
                highlights.forEach(highlight => {
                    const parent = highlight.parentNode;
                    parent.replaceChild(document.createTextNode(highlight.textContent), highlight);
                    parent.normalize();
                });
                
                this.savedHighlights = [];
                this.savedContent.style.display = 'none';
                this.selectedHighlight = null;
            }

            updateDisplay() {
                const text = this.textInput.value;
                const format = this.formatSelect.value;
                
                if (text.trim() === '') {
                    this.displayContent.innerHTML = '<p>åœ¨å·¦ä¾§è¾“å…¥æ¡†ä¸­è¾“å…¥æ–‡æœ¬ï¼Œå†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤ºã€‚ä½¿ç”¨é«˜äº®å·¥å…·å¯ä»¥æ ‡è®°é‡è¦å†…å®¹ã€‚</p>';
                } else {
                    if (format === 'markdown') {
                        // ç®€å•çš„markdownæ¸²æŸ“
                        let formattedText = text
                            // æ ‡é¢˜
                            .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                            .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                            .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                            // ç²—ä½“å’Œæ–œä½“
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/\*(.*?)\*/g, '<em>$1</em>')
                            // ä»£ç 
                            .replace(/`(.*?)`/g, '<code style="background: #f4f4f4; padding: 2px 4px; border-radius: 3px;">$1</code>')
                            // é“¾æ¥
                            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #007bff;">$1</a>')
                            // æ¢è¡Œ
                            .replace(/\n/g, '<br>');
                        
                        this.displayContent.innerHTML = `<div>${formattedText}</div>`;
                    } else {
                        // çº¯æ–‡æœ¬æ ¼å¼ï¼Œä¿æŒæ¢è¡Œ
                        const formattedText = text.replace(/\n/g, '<br>');
                        this.displayContent.innerHTML = `<div>${formattedText}</div>`;
                    }
                }
            }

            toggleSavedSection() {
                const isCollapsed = this.savedContent.classList.contains('collapsed');
                this.savedContent.classList.toggle('collapsed');
                this.savedToggleBtn.textContent = isCollapsed ? 'æ”¶èµ·' : 'å±•å¼€';
            }

            toggleInputSection() {
                const isCollapsed = this.inputSection.classList.contains('collapsed');
                this.inputSection.classList.toggle('collapsed');
                this.collapseBtn.style.display = isCollapsed ? 'block' : 'none';
                this.expandBtn.style.display = isCollapsed ? 'none' : 'block';
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        let highlighter;
        document.addEventListener('DOMContentLoaded', () => {
            highlighter = new TextHighlighter();
        });
    </script>
</body>
</html>
